MODULE System1;  (*top module for a boot file containing the entire Oberon system / AP 1.5.22*)
  IMPORT SYSTEM, Files, Modules, Oberon, System, Oberon0, Oberon0Tool;

  PROCEDURE InitDefaultFont;  (*create the default font file Oberon10.Scn.Fnt if necessary*)
    VAR FntAdr: ARRAY 16 OF INTEGER;
      FntSize, i: INTEGER; ch: CHAR;
      F: Files.File; R: Files.Rider;
  BEGIN F := Files.Old("Oberon10.Scn.Fnt");
    IF F = NIL THEN FntSize := 8*8*32 + 7*32 + 12; (*2284*)
      (*the hexstrings below were created using a Unix-style hexdump command from the file Oberon10.Scn.Fnt*)
      FntAdr[0] := SYSTEM.ADR($
        DB 00 53 20 0C 00 00 00 0A 00 FD FF 09 00 06 00
        09 00 0A 00 1A 00 7F 00 80 00 96 00 9B 00 9C 00
        9F 00 A0 00 AB 00 AC 00 0C 00 00 00 00 00 00 00
        00 00 08 00 02 00 00 00 05 00 09 00 08 00 02 00
        00 00 05 00 09 00 08 00 01 00 00 00 06 00 06 00
        08 00 01 00 00 00 06 00 06 00 08 00 01 00 00 00
        05 00 09 00 08 00 01 00 00 00 05 00 09 00 03 00
        00 00 00 00 00 00 00 00 04 00 02 00 00 00 01 00
        08 00 05 00 01 00 05 00 03 00 03 00 07 00 01 00
        00 00 05 00 08 00 06 00 00 00 FF FF 05 00 0A 00
        08 00 01 00 00 00 06 00 08 00 06 00 00 00 00 00
        05 00 08 00 03 00 01 00 05 00 01 00 03 00 04 00
        01 00 FE FF 03 00 0B 00 04 00 00 00 FE FF 03 00
        0B 00 06 00 01 00 01 00 05 00 05 00 06 00 01 00
        01 00 05 00 05 00 03 00 01 00 FE FF 01 00 04 00
        06 00 01 00 03 00 05 00 01 00 03 00 01 00 00 00$);
      FntAdr[1] := SYSTEM.ADR($
        01 00 02 00 06 00 01 00 00 00 04 00 08 00 06 00
        00 00 00 00 05 00 08 00 06 00 01 00 00 00 03 00
        08 00 06 00 01 00 00 00 05 00 08 00 06 00 01 00
        00 00 04 00 08 00 06 00 00 00 00 00 06 00 08 00
        06 00 01 00 00 00 04 00 08 00 06 00 00 00 00 00
        05 00 08 00 06 00 00 00 00 00 05 00 08 00 06 00
        00 00 00 00 05 00 08 00 06 00 00 00 00 00 05 00
        08 00 03 00 01 00 00 00 01 00 06 00 03 00 01 00
        FE FF 01 00 08 00 06 00 00 00 00 00 06 00 06 00
        06 00 01 00 02 00 05 00 03 00 06 00 00 00 00 00
        06 00 06 00 05 00 01 00 00 00 04 00 08 00 0A 00
        01 00 FE FF 08 00 0A 00 07 00 00 00 00 00 07 00
        08 00 07 00 01 00 00 00 05 00 08 00 06 00 01 00
        00 00 05 00 08 00 08 00 01 00 00 00 06 00 08 00
        06 00 01 00 00 00 04 00 08 00 05 00 01 00 00 00
        04 00 08 00 07 00 00 00 00 00 06 00 08 00 07 00$);
      FntAdr[2] := SYSTEM.ADR($
        01 00 00 00 05 00 08 00 03 00 01 00 00 00 01 00
        08 00 03 00 00 00 00 00 02 00 08 00 06 00 01 00
        00 00 05 00 08 00 05 00 01 00 00 00 04 00 08 00
        09 00 00 00 00 00 09 00 08 00 08 00 01 00 00 00
        06 00 08 00 09 00 01 00 00 00 07 00 08 00 06 00
        01 00 00 00 05 00 08 00 09 00 01 00 FE FF 07 00
        0A 00 07 00 01 00 00 00 05 00 08 00 06 00 01 00
        00 00 04 00 08 00 05 00 00 00 00 00 05 00 08 00
        07 00 01 00 00 00 05 00 08 00 06 00 00 00 00 00
        06 00 08 00 0A 00 00 00 00 00 0A 00 08 00 07 00
        01 00 00 00 05 00 08 00 05 00 00 00 00 00 05 00
        08 00 06 00 01 00 00 00 04 00 08 00 04 00 01 00
        FE FF 03 00 0B 00 06 00 01 00 FF FF 04 00 08 00
        04 00 00 00 FE FF 03 00 0B 00 06 00 01 00 00 00
        05 00 07 00 03 00 00 00 03 00 03 00 01 00 05 00
        01 00 07 00 02 00 02 00 06 00 01 00 00 00 04 00$);
      FntAdr[3] := SYSTEM.ADR($
        06 00 06 00 01 00 00 00 04 00 09 00 05 00 01 00
        00 00 04 00 06 00 06 00 01 00 00 00 04 00 09 00
        06 00 01 00 00 00 04 00 06 00 03 00 00 00 00 00
        03 00 09 00 06 00 01 00 FD FF 05 00 09 00 06 00
        01 00 00 00 04 00 09 00 03 00 01 00 00 00 01 00
        08 00 03 00 00 00 FD FF 02 00 0B 00 05 00 01 00
        00 00 04 00 09 00 03 00 01 00 00 00 01 00 09 00
        09 00 01 00 00 00 07 00 06 00 06 00 01 00 00 00
        04 00 06 00 06 00 01 00 00 00 04 00 06 00 06 00
        01 00 FD FF 04 00 09 00 06 00 01 00 FD FF 04 00
        09 00 04 00 01 00 00 00 03 00 06 00 04 00 01 00
        00 00 03 00 06 00 04 00 00 00 00 00 04 00 08 00
        06 00 01 00 00 00 04 00 06 00 05 00 00 00 00 00
        05 00 06 00 09 00 00 00 00 00 09 00 06 00 06 00
        01 00 00 00 04 00 06 00 05 00 00 00 FD FF 05 00
        09 00 04 00 00 00 00 00 04 00 06 00 04 00 00 00$);
      FntAdr[4] := SYSTEM.ADR($
        FE FF 03 00 0B 00 05 00 02 00 FE FF 01 00 0B 00
        04 00 01 00 FE FF 03 00 0B 00 06 00 00 00 02 00
        06 00 02 00 07 00 00 00 00 00 07 00 09 00 09 00
        01 00 00 00 07 00 09 00 07 00 01 00 00 00 05 00
        08 00 06 00 01 00 00 00 04 00 08 00 06 00 01 00
        00 00 04 00 08 00 06 00 01 00 00 00 04 00 08 00
        06 00 01 00 00 00 04 00 09 00 06 00 01 00 00 00
        04 00 09 00 03 00 00 00 00 00 03 00 09 00 06 00
        01 00 00 00 04 00 09 00 06 00 01 00 00 00 04 00
        09 00 06 00 01 00 00 00 04 00 09 00 06 00 01 00
        00 00 04 00 09 00 03 00 01 00 00 00 02 00 09 00
        06 00 01 00 00 00 04 00 09 00 06 00 01 00 00 00
        04 00 09 00 06 00 01 00 00 00 04 00 09 00 06 00
        01 00 00 00 04 00 08 00 03 00 00 00 00 00 03 00
        08 00 05 00 01 00 FD FF 04 00 09 00 06 00 01 00
        00 00 04 00 09 00 06 00 01 00 00 00 04 00 09 00$);
      FntAdr[5] := SYSTEM.ADR($
        06 00 00 00 02 00 06 00 01 00 06 00 00 00 00 00
        00 00 00 00 06 00 01 00 00 00 05 00 09 00 01 03
        05 09 11 09 05 03 01 01 03 07 0F 1F 0F 07 03 01
        3F 21 21 21 21 3F 3F 3F 3F 3F 3F 3F 10 18 14 12
        11 12 14 18 10 10 18 1C 1E 1F 1E 1C 18 10 01 00
        00 01 01 01 01 01 05 05 05 0A 0A 1F 0A 0A 1F 0A
        0A 04 0F 14 14 0C 06 05 05 1E 04 1A 2A 2C 34 0B
        0D 15 16 1B 0D 19 0A 04 0A 0A 0C 01 01 01 04 02
        02 01 01 01 01 01 02 02 04 01 02 02 04 04 04 04
        04 02 02 01 0A 04 1F 04 0A 04 04 1F 04 04 01 01
        01 01 1F 01 01 01 01 02 02 04 04 08 08 0E 11 11
        11 11 11 11 0E 04 04 04 04 04 05 06 04 1F 01 02
        04 04 08 08 07 07 08 08 08 07 08 08 07 08 08 08
        3F 09 0A 0C 08 07 08 08 08 07 01 02 0E 0E 11 11
        13 0D 01 02 1C 02 02 04 04 08 08 10 1F 0E 11 11
        11 0E 11 11 0E 07 08 10 16 19 11 11 0E 01 01 00$);
      FntAdr[6] := SYSTEM.ADR($
        00 01 01 01 01 01 01 00 00 01 01 30 0C 03 03 0C
        30 1F 00 1F 03 0C 30 30 0C 03 02 00 02 02 04 08
        08 07 1C 02 6D B5 A5 A5 A5 B9 42 3C 41 41 22 3E
        14 14 08 08 0F 11 11 11 0F 11 11 0F 1C 02 01 01
        01 01 02 1C 0F 11 21 21 21 21 11 0F 0F 01 01 01
        0F 01 01 0F 01 01 01 01 0F 01 01 0F 3C 22 21 21
        01 01 02 1C 11 11 11 11 1F 11 11 11 01 01 01 01
        01 01 01 01 03 02 02 02 02 02 02 02 11 09 05 03
        03 05 09 11 0F 01 01 01 01 01 01 01 11 01 11 01
        11 01 AA 00 AA 00 AA 00 44 00 44 00 31 31 29 29
        25 25 23 23 1C 22 41 41 41 41 22 1C 01 01 01 01
        0F 11 11 0F 60 10 1C 22 41 41 41 41 22 1C 11 11
        09 05 0F 11 11 0F 07 08 08 04 02 01 01 0E 04 04
        04 04 04 04 04 1F 0E 11 11 11 11 11 11 11 0C 0C
        12 12 12 21 21 21 84 00 84 00 4A 01 4A 01 4A 01
        31 02 31 02 31 02 11 11 0A 04 04 0A 11 11 04 04$);
      FntAdr[7] := SYSTEM.ADR($
        04 04 0A 0A 11 11 0F 01 02 02 04 04 08 0F 07 01
        01 01 01 01 01 01 01 01 07 08 08 04 04 02 02 01
        01 07 04 04 04 04 04 04 04 04 04 07 04 04 04 04
        15 0A 04 07 02 01 0B 0D 09 0E 09 0E 07 09 09 09
        0B 0D 01 01 01 07 09 01 01 01 0E 0B 0D 09 09 09
        0E 08 08 08 07 09 01 0F 09 0E 02 02 02 02 02 07
        02 02 06 07 09 09 0E 02 07 09 09 1E 09 09 09 09
        0B 0D 01 01 01 01 01 01 01 01 01 00 01 01 02 02
        02 02 02 02 02 02 00 02 09 05 03 03 05 09 01 01
        01 01 01 01 01 01 01 01 01 01 49 49 49 49 5B 6D
        09 09 09 09 0B 0D 07 09 09 09 09 0E 01 01 01 07
        09 09 09 0B 0D 08 08 08 0B 0D 09 09 09 0E 01 01
        01 01 07 05 03 04 06 03 01 06 06 0A 02 02 02 0F
        02 02 0B 0D 09 09 09 09 04 04 0A 0A 11 11 44 00
        44 00 AA 00 AA 00 11 01 11 01 09 09 06 06 09 09
        01 02 02 04 04 0A 0A 11 11 0F 01 02 04 08 0F 04$);
      FntAdr[8] := SYSTEM.ADR($
        02 02 02 02 01 02 02 02 02 04 01 01 01 01 01 01
        01 01 01 01 01 01 02 02 02 02 04 02 02 02 02 01
        19 26 41 41 22 3E 14 14 08 08 22 1C 22 41 41 41
        41 22 1C 22 0E 11 11 11 11 11 15 15 0B 0D 09 0E
        09 0E 00 0A 07 09 09 09 09 0E 00 0A 0B 0D 09 09
        09 09 00 09 0B 0D 09 0E 09 0E 00 0A 04 07 09 01
        0F 09 0E 00 0A 04 02 02 02 02 02 02 00 05 02 07
        09 09 09 09 0E 00 09 06 0B 0D 09 09 09 09 00 09
        06 0B 0D 09 0E 09 0E 00 04 02 07 09 01 0F 09 0E
        00 04 02 01 01 01 01 01 01 00 02 01 07 09 09 09
        09 0E 00 04 02 0B 0D 09 09 09 09 00 04 02 07 09
        01 0F 09 0E 00 04 08 07 09 01 0F 09 0E 00 0A 02
        02 02 02 02 02 00 05 04 06 00 07 09 01 01 01 0E
        0B 0D 09 0E 09 0E 00 04 08 09 09 09 09 0B 0D 00
        05 0A 3F 0D 11 11 11 09 05 09 09 06$);
      F := Files.New("Oberon10.Scn.Fnt"); Files.Set(R, F, 0); Files.Set(R, F, 0);
      FOR i := 0 TO FntSize-1 DO SYSTEM.GET(FntAdr[0] + i, ch); Files.Write(R, ch) END ;
      Files.Register(F)
    END
  END InitDefaultFont;

  PROCEDURE InitMod(name: ARRAY OF CHAR);  (*call the module initialization body of the specified module*)
    VAR mod: Modules.Module; body: Modules.Command; w: INTEGER;
  BEGIN mod := Modules.root;
    WHILE (mod # NIL) & (name # mod.name) DO mod := mod.next END ;
    IF mod # NIL THEN SYSTEM.GET(mod.ent, w);
      body := SYSTEM.VAL(Modules.Command, mod.prg + w); body
    END
  END InitMod;

BEGIN
  IF Modules.importing # "System1" THEN  (*loaded by the boot loader*)
    Oberon0.Init;  (*establish a working file system (root page) if necessary*)
    Modules.Init;  (*initialize the inner core*)
    InitMod("Input");
    InitMod("Display");
    InitMod("Viewers");
    InitDefaultFont; InitMod("Fonts");
    InitMod("Texts");
    InitMod("Oberon");  (*does not load module System nor start the Oberon loop*)
    InitMod("MenuViewers");
    InitMod("TextFrames");
    InitMod("System");
    (*Do NOT initialize module Oberon0!*)
    InitMod("Oberon0Tool"); Oberon0Tool.Run;
    Modules.Free("System1", FALSE);  (*unload myself*)
    Oberon.Reset
  END
END System1.
